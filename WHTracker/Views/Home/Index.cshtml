@{
    ViewData["Title"] = "Home Page";
}
@section Stylesheets{
    <link rel="stylesheet" href="https://cdn.datatables.net/1.10.21/css/dataTables.bootstrap4.min.css" />
}

<div class="">
    <select id="DMPick" >
        <option value="day">Daily</option>
        <option value="month">Monthly</option>
    </select>
    <input type="date" class="picker" value="@DateTime.UtcNow.ToString("yyyy-MM-dd")" id="date" />
    <select id="CAType" class="picker">
        <option>Corporation</option>
        <option>Alliance</option>
    </select>
    <table id="whdata" class="table table-striped table-bordered whdata" style="width:100%">
        <thead>
            <tr>
                <th>

                </th>
                <th>
                    Corporation
                </th>
                <th>
                    Kills
                </th>
                <th>
                    Losses
                </th>
                <th>
                    ISK killed
                </th>
                <th>
                    ISK lost
                </th>
                <th>
                    Damage Dealt
                </th>
                <th>
                    Damage Taken
                </th>
                <th>
                    R
                </th>
                <th>
                    D
                </th>
                <th>
                    C
                </th>
                <th>
                    F
                </th>
                <th>
                    A
                </th>
                <th>
                    F
                </th>
                <th>
                    K
                </th>
            </tr>
        </thead>
        <tbody>
        </tbody>
    </table>
</div>

@section Scripts{
    <script>
        $(document).ready(function () {
            var table = $('#whdata').DataTable({
                scrollY: 650,
                scrollY: '69VH',
                scrollCollapse: true,
                "deferRender": true,
                "lengthMenu": [10,20 , 30, 60, 120],
                pageLength: 30,
                ajax: "/api/Aggregate/corporation/day/@DateTime.UtcNow.ToString("yyyy-MM-dd")",
                "order": [[3, "desc"]],
                columns: [
                    {
                        "className": 'details-control',
                        "orderable": false,
                        "data": null,
                        "defaultContent": ''
                    },
                    {
                        render: function (data, type, row) {
                            var catype = $("#CAType").val() == "Corporation" ? "corporations" : "alliances";
                            var zkcatype = $("#CAType").val() == "Corporation" ? "corporation" : "alliance";
                            var caid = $("#CAType").val() == "Corporation" ? row.corporationID : row.allianceId;
                            var caname = $("#CAType").val() == "Corporation" ? row.corporation.corporationName : row.alliance.allianceName;
                            return '<a href="https://zkillboard.com/' + zkcatype + '/' + caid + '/" target="_Blank"><img height="24px" src="https://images.evetech.net/' + catype + '/' + caid + '/logo?size=32"/> ' + caname + '</a>';
                        },
                    },
                    { "data": "killsTotal" },
                    { "data": "lossesTotal" },
                    {
                        "data": "iskKilledTotal",
                        render: $.fn.dataTable.render.number(',', '.', 0, '',' ISK')
                    },
                    {
                        "data": "iskLostTotal",
                        render: $.fn.dataTable.render.number(',', '.', 0, '', ' ISK')
                    },
                    { "data": "damageDealtTotal" },
                    { "data": "damageTakenTotal" },
                    { "data": "rorqualKills" },
                    { "data": "dreadKills" },
                    { "data": "carrierKills" },
                    { "data": "faxesKills" },
                    { "data": "mediumStructureKills" },
                    { "data": "largeStructureKills" },
                    { "data": "xlStructureKills" },


                ]
            });


            $('#whdata tbody').on('click', 'td.details-control', function () {
                var tr = $(this).closest('tr');
                var row = table.row(tr);

                if (row.child.isShown()) {
                    // This row is already open - close it
                    row.child.hide();
                    tr.removeClass('shown');
                }
                else {
                    // Open this row
                    row.child(format(row.data())).show();
                    tr.addClass('shown');
                }
            });

            $(".picker").change(function () {
                table.ajax.url("/api/Aggregate/" + $("#CAType").val() + "/" + $("#DMPick").val() + "/" + $("#date").val()).load();

            })

            $("#DMPick").change(function () {
                if ($("#DMPick").val() == "month") {
                    $("#date")[0].type = "month";
                    $("#date")[0].value = getMonth();
                } else {
                    $("#date")[0].type = "date";
                    $("#date")[0].value = getDay();
                }
                table.ajax.url("/api/Aggregate/" + $("#CAType").val() + "/" + $("#DMPick").val() + "/" + $("#date").val()).load();

            })
        });

        function format(d) {
            // `d` is the original data object for the row
            return '<table cellpadding="5" cellspacing="0" border="0" style="margin-left:34px;">' +
                '<tr>' +
                '<td>Full name:</td>' +
                '<td>' + d.corporation.corporationName + '</td>' +
                '</tr>' +
                '<tr>' +
                '<td>Ticker:</td>' +
                '<td>' + d.corporation.corporationTicker + '</td>' +
                '</tr>' +
                '<tr>' +
                '<td>Extra info:</td>' +
                '<td></td>' +
                '</tr>' +
                '</table>';
        }


        function getDay() {
            var date = new Date();
            var mm = date.getUTCMonth()+1;
            return date.getUTCFullYear() + "-" + IntWithZero(mm) + "-" + IntWithZero(date.getUTCDate())
        }

        function getMonth() {
            var date = new Date();
            var mm = date.getUTCMonth() + 1;
            return date.getUTCFullYear() + "-" + IntWithZero(mm)
        }

        function IntWithZero(mm) {
            if (mm < 10) {
                mm = '0' + mm;
            }
            return mm;
        }

    </script>
    <script src="https://cdn.datatables.net/1.10.21/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.10.21/js/dataTables.bootstrap4.min.js"></script>
}
