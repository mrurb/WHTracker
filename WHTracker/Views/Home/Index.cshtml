@{
    ViewData["Title"] = "Home Page";
}
@section Stylesheets{
    <link rel="stylesheet" href="https://cdn.datatables.net/1.10.21/css/dataTables.bootstrap4.min.css" />
}

<div class="">
    <select id="DMPick" >
        <option value="day">Daily</option>
        <option value="month">Monthly</option>
    </select>
    <input type="date" class="picker" value="@DateTime.UtcNow.ToString("yyyy-MM-dd")" id="date" />
    <select id="CAType" class="picker">
        <option>Corporation</option>
        <option>Alliance</option>
    </select>
    <table id="whdata" class="table table-striped table-bordered whdata" style="width:100%">
        <thead>
            <tr>
                <th>

                </th>
                <th>
                    Corporation
                </th>
                <th>
                    Kills
                </th>
                <th>
                    Losses
                </th>
                <th>
                    ISK killed
                </th>
                <th>
                    ISK lost
                </th>
                <th>
                    Damage Dealt
                </th>
                <th>
                    Damage Taken
                </th>
                <th>
                    R
                </th>
                <th>
                    D
                </th>
                <th>
                    C
                </th>
                <th>
                    F
                </th>
                <th>
                    A
                </th>
                <th>
                    F
                </th>
                <th>
                    K
                </th>
            </tr>
        </thead>
        <tbody>
        </tbody>
    </table>
</div>

@section Scripts{
    <script>
        $(document).ready(function () {
            var table = $('#whdata').DataTable({
                scrollY: 650,
                scrollY: '69VH',
                scrollCollapse: true,
                "deferRender": true,
                "lengthMenu": [10,20 , 30, 60, 120],
                pageLength: 30,
                ajax: "/api/Aggregate/corporation/day/@DateTime.UtcNow.ToString("yyyy-MM-dd")",
                "order": [[4, "desc"]],
                columns: [
                    {
                        "className": 'details-control',
                        "orderable": false,
                        "data": null,
                        "defaultContent": ''
                    },
                    {
                        render: function (data, type, row) {
                            var catype = $("#CAType").val() == "Corporation" ? "corporations" : "alliances";
                            var zkcatype = $("#CAType").val() == "Corporation" ? "corporation" : "alliance";
                            var ca = $("#CAType").val() == "Corporation" ? row.corporation : row.alliance;
                            console.log(ca);
                            return '<a href="https://zkillboard.com/' + zkcatype + '/' + ca.id + '/" target="_Blank"><img height="24px" src="https://images.evetech.net/' + catype + '/' + ca.id + '/logo?size=32"/> ' + ca.name + '</a>';
                        },
                    },
                    { "data": "killsTotal" },
                    { "data": "lossesTotal" },
                    {
                        "data": "iskKilledTotal",
                        render: $.fn.dataTable.render.number(',', '.', 0, '',' ISK')
                    },
                    {
                        "data": "iskLostTotal",
                        render: $.fn.dataTable.render.number(',', '.', 0, '', ' ISK')
                    },
                    { "data": "damageDealtTotal" },
                    { "data": "damageTakenTotal" },
                    { "data": "rorqualKills" },
                    { "data": "dreadKills" },
                    { "data": "carrierKills" },
                    { "data": "faxesKills" },
                    { "data": "mediumStructureKills" },
                    { "data": "largeStructureKills" },
                    { "data": "xlStructureKills" },


                ]
            });


            $('#whdata tbody').on('click', 'td.details-control', function () {
                var tr = $(this).closest('tr');
                var row = table.row(tr);

                if (row.child.isShown()) {
                    // This row is already open - close it
                    row.child.hide();
                    tr.removeClass('shown');
                }
                else {
                    // Open this row
                    row.child(template("ChildTemplate",row.data())).show();
                    tr.addClass('shown');
                }
            });

            $(".picker").change(function () {
                table.ajax.url("/api/Aggregate/" + $("#CAType").val() + "/" + $("#DMPick").val() + "/" + $("#date").val()).load();

            })

            $("#DMPick").change(function () {
                if ($("#DMPick").val() == "month") {
                    $("#date")[0].type = "month";
                    $("#date")[0].value = getMonth();
                } else {
                    $("#date")[0].type = "date";
                    $("#date")[0].value = getDay();
                }
                table.ajax.url("/api/Aggregate/" + $("#CAType").val() + "/" + $("#DMPick").val() + "/" + $("#date").val()).load();

            })
        });

        function template(templateid, data) {
            return document.getElementById(templateid).innerHTML
                .replace(
                    /{(\w.*)}/g, // or /{(\w*)}/g for "{this} instead of %this%"
                    function (m, key) {
                        var keys = key.split(".");
                        if (keys.length > 1) {
                            if (keys[0] == "corporation" || keys[0] == "alliance") {
                                keys[0] = $("#CAType").val() == "Corporation" ? "corporation" : "alliance";
                            }
                            return data.hasOwnProperty(keys[0]) ? data[keys[0]][keys[1]] : ""
                        }

                        return data.hasOwnProperty(key) ? data[key] : "";
                    }
                );
        }

        function getDay() {
            var date = new Date();
            var mm = date.getUTCMonth()+1;
            return date.getUTCFullYear() + "-" + IntWithZero(mm) + "-" + IntWithZero(date.getUTCDate())
        }

        function getMonth() {
            var date = new Date();
            var mm = date.getUTCMonth() + 1;
            return date.getUTCFullYear() + "-" + IntWithZero(mm)
        }

        function IntWithZero(mm) {
            if (mm < 10) {
                mm = '0' + mm;
            }
            return mm;
        }

    </script>
    <template id="ChildTemplate">
        <table  style="margin-left:34px;display:inline;">
            <tr>
                <td>Name</td>
                <td>{corporation.name}</td>

            </tr>
            <tr>
                <td>Ticker:</td>
                <td>{corporation.ticker}</td>
            </tr>
            <tr>
                <td>Member count:</td>
                <td>{corporation.memberCount}</td>
            </tr>
        </table>
        <table style="margin-left:34px;display:inline;">
            <thead>
                <tr>
                    <th></th>
                    <th>Kills</th>
                    <th>Losses</th>
                    <th>ISk Killed</th>
                    <th>ISK Lost</th>
                    <th>Damage dealt</th>
                    <th>Damage taken</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>total:</td>
                    <td>{killsTotal}</td>
                    <td>{lossesTotal}</td>
                    <td>{iskKilledTotal}</td>
                    <td>{iskLostTotal}</td>
                    <td>{damageDealtTotal}</td>
                    <td>{damageTakenTotal}</td>
                </tr>
                <tr>
                    <td>Pod:</td>
                    <td>{killsPod}</td>
                    <td>{lossesPod}</td>
                    <td>{iskKilledPod}</td>
                    <td>{iskLostPod}</td>
                    <td>{damageDealtPod}</td>
                    <td>{damageTakenPod}</td>
                </tr>
                <tr>
                    <td>Sub cap:</td>
                    <td>{killsSubCap}</td>
                    <td>{lossesSubCap}</td>
                    <td>{iskKilledSubCap}</td>
                    <td>{iskLostSubCap}</td>
                    <td>{damageDealtSubCap}</td>
                    <td>{damageTakenSubCap}</td>
                </tr>
                <tr>
                    <td>Capital:</td>
                    <td>{killsCapital}</td>
                    <td>{lossesCapital}</td>
                    <td>{iskKilledCapital}</td>
                    <td>{iskLostCapital}</td>
                    <td>{damageDealtCapital}</td>
                    <td>{damageTakenCapital}</td>
                </tr>
                <tr>
                    <td>Structure:</td>
                    <td>{killsStructure}</td>
                    <td>{lossesStructure}</td>
                    <td>{iskKilledStructure}</td>
                    <td>{iskLostStructure}</td>
                    <td>{damageDealtStructure}</td>
                    <td>{damageTakenStructure}</td>
                </tr>
            </tbody>
        </table>
        <table style="margin-left:34px;display:inline;">
            <thead>
                <tr>
                    <th></th>
                    <th>Kills</th>
                    <th>Losses</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>Rorqual:</td>
                    <td>{rorqualKills}</td>
                    <td>{rorqualLosses}</td>
                </tr>
                <tr>
                    <td>Dread:</td>
                    <td>{dreadKills}</td>
                    <td>{dreadLosses}</td>
                </tr>
                <tr>
                    <td>Carrier:</td>
                    <td>{carrierKills}</td>
                    <td>{carrierLosses}</td>
                </tr>
                <tr>
                    <td>Faxes:</td>
                    <td>{faxesKills}</td>
                    <td>{faxesLosses}</td>
                </tr>
            </tbody>
        </table>
        <table style="margin-left:34px;display:inline;">
            <thead>
                <tr>
                    <th></th>
                    <th>Kills</th>
                    <th>Losses</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>Medium structure:</td>
                    <td>{mediumStructureKills}</td>
                    <td>{mediumStructureLosses}</td>
                </tr>
                <tr>
                    <td>Large structure:</td>
                    <td>{largeStructureKills}</td>
                    <td>{largeStructureLosses}</td>
                </tr>
                <tr>
                    <td>XL structure:</td>
                    <td>{xlStructureKills}</td>
                    <td>{xlStructureLosses}</td>
                </tr>
            </tbody>
        </table>
    </template>
    <script src="https://cdn.datatables.net/1.10.21/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.10.21/js/dataTables.bootstrap4.min.js"></script>
}
